<script>
(function(){
  const AUDIO_URL = "https://h.uguu.se/kwmAtLDd.mp3";
  const audioEl = document.getElementById('bgAudio');
  const gate = document.getElementById('soundGate');
  const startBtn = document.getElementById('startSoundBtn');

  // رسالة مساعدة بسيطة
  function tip(msg){
    startBtn.textContent = msg + " — اضغط مرة أخرى 🎵";
    setTimeout(()=>{ startBtn.textContent = "اضغط للدخول 🎵"; }, 2500);
  }

  async function playViaHTMLAudio(){
    try {
      audioEl.pause();
      audioEl.currentTime = 0;
      audioEl.muted = false;
      // بعض المتصفحات تحتاج load قبل play
      audioEl.load();
      await audioEl.play();
      return true;
    } catch (e) {
      return false;
    }
  }

  async function playViaWebAudio(){
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return false;
      const ctx = new AC();
      const resp = await fetch(AUDIO_URL, { mode: 'cors', cache: 'no-store' });
      const buf = await resp.arrayBuffer();
      const audioBuf = await ctx.decodeAudioData(buf);
      const src = ctx.createBufferSource();
      src.buffer = audioBuf;
      src.connect(ctx.destination);
      src.start(0);
      // نخلي الطبقة تختفي ونسيب الصوت يكمّل
      return true;
    } catch(e){
      return false;
    }
  }

  async function start(){
    startBtn.disabled = true;

    // المحاولة 1: عنصر الصوت العادي
    let ok = await playViaHTMLAudio();
    if (ok){
      gate.style.display = 'none';
      startBtn.disabled = false;
      return;
    }

    // المحاولة 2: WebAudio (Fallback قوي)
    ok = await playViaWebAudio();
    if (ok){
      gate.style.display = 'none';
      startBtn.disabled = false;
      return;
    }

    // لو فشل الاتنين (نادرًا): اطلب إعادة الضغط
    tip("المتصفح منع التشغيل");
    startBtn.disabled = false;
  }

  // اربط الحدث
  startBtn.addEventListener('click', start, { passive: true });

  // نخلي الطبقة ظاهرة دائمًا لحد ما يضغط
  gate.style.display = 'grid';
})();
</script>
