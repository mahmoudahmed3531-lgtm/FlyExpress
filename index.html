<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fly Rider — العب واكسب توصيلة مجانية</title>
<style>
:root{
  --ink:#0a1a28; --ink2:#0e2436; --card:#0f2134; --soft:#e9f2ff;
  --accent:#15d1a3; --accent2:#5ee1ff; --danger:#ff5d5d; --good:#2ecc71;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:#081521; color:#eaf4ff; font-family:system-ui,"Cairo",Segoe UI,Roboto,Arial;
}
.wrap{max-width:980px;margin:0 auto;padding:20px}
header{display:flex;align-items:center;justify-content:center;gap:12px;margin:8px 0 10px}
h1{font-size:40px;line-height:1.1;margin:0;text-shadow:0 6px 22px rgba(0,0,0,.35)}
h1 .bike{filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
.stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:8px 0 14px}
.badge{
  background:linear-gradient(180deg,#0f2a41,#0d2134);
  border:1px solid rgba(255,255,255,.08); color:#dff2ff;
  padding:12px 18px; border-radius:16px; font-weight:800; box-shadow:0 10px 28px rgba(1,7,13,.45) inset, 0 10px 30px rgba(0,0,0,.25);
}
.btn{
  border:none; background:linear-gradient(180deg,#22e0b5,#18cfa7);
  color:#06252a; font-weight:900; padding:12px 18px; border-radius:999px; cursor:pointer;
  box-shadow:0 12px 30px rgba(21,209,163,.35), inset 0 0 0 1px rgba(255,255,255,.5);
}
.btn:active{transform:translateY(1px)}
.btn.mute{background:linear-gradient(180deg,#5ee1ff,#48c6ff); color:#032336}

.frame{
  position:relative;border-radius:24px;overflow:hidden;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 30px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
}
.canvasWrap{padding:14px;border-radius:24px;background:radial-gradient(120% 140% at 50% 0%,#11263c 0,#0b1b2b 55%,#0a1724 100%)}
canvas{display:block;width:100%;height:360px;border-radius:18px; background:transparent}

.note{margin:12px auto 0;max-width:840px;text-align:center;color:#bfe6ff}
.kbd{padding:2px 8px;border-radius:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-weight:800}

.toast{
  position:fixed; inset:auto 12px 14px 12px; margin:auto; max-width:600px; text-align:center;
  background:linear-gradient(180deg,#102338,#0a1a28); border:1px solid rgba(255,255,255,.08);
  color:#eaf6ff; padding:12px 14px; border-radius:14px; box-shadow:0 22px 50px rgba(0,0,0,.45); display:none
}
.toast.show{display:block; animation:pop .3s ease}
@keyframes pop{from{transform:translateY(6px);opacity:0}to{transform:translateY(0);opacity:1}}

.cityBanner{
  position:absolute; left:50%; top:10px; transform:translate(-50%,-140%);
  background:linear-gradient(180deg,#1b3550,#0f2236); border:1px solid rgba(255,255,255,.15);
  color:#e9f6ff; padding:10px 14px; border-radius:12px; font-weight:900; letter-spacing:.3px; box-shadow:0 18px 40px rgba(0,0,0,.45);
}
.cityBanner.show{animation:slideIn .5s ease forwards}
@keyframes slideIn{to{transform:translate(-50%,0)}}

.hint{margin-top:10px;text-align:center;color:#a9d6ff}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fly Rider <span class="bike">🏍️</span></h1>
    </header>

    <div class="stats">
      <div class="badge">أعلى نتيجة: <span id="best">0</span></div>
      <div class="badge">المسافة: <span id="dist">0</span> / 10000</div>
      <button id="btnStart" class="btn">ابدأ</button>
      <button id="btnMute" class="btn mute">إيقاف الصوت 🔊</button>
    </div>

    <div class="frame canvasWrap">
      <div id="cityBanner" class="cityBanner">🚏 وصلت: <span id="cityName">-</span></div>
      <canvas id="game" width="960" height="360" aria-label="Fly Rider Game"></canvas>
    </div>

    <div class="note">
      اضغط <span class="kbd">ابدأ</span> أو المس الشاشة للانطلاق — الهدف:
      <b>10000</b> نقطة — <span class="kbd">القفز</span> بالسهم ↑ أو اللمس.  
      توجد مهلة أمان قصيرة عند البداية.
    </div>

    <div id="toast" class="toast"></div>
    <p class="hint">✨ لو خبطت في عائق — اضغط الشاشة لإعادة المحاولة</p>
  </div>

<script>
/* ====== إعدادات عامة ====== */

// صورة السائق (يمكنك تبديل الرابط هنا)
const RIDER_IMG = "https://i.ibb.co/1tr7xqfR/Picsart-25-10-16-13-30-56-445.png";

// المدن كل 1000 نقطة
const CITIES = [
  "نجع حمادي","قفط","قنا","فرشوط","أبوتشت",
  "الوقف","سوهاج","جرجا","أخميم","أسيوط"
];

// عناصر DOM
const canvas = document.getElementById('game');
const c = canvas.getContext('2d');
const toast = document.getElementById('toast');
const bestEl = document.getElementById('best');
const distEl = document.getElementById('dist');
const btnStart = document.getElementById('btnStart');
const btnMute = document.getElementById('btnMute');
const banner = document.getElementById('cityBanner');
const bannerCity = document.getElementById('cityName');

// DPI fix
const dpi = Math.max(1, window.devicePixelRatio || 1);
function fixDPI(){
  const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
  canvas.width = Math.round(cssW * dpi);
  canvas.height = Math.round(cssH * dpi);
  c.setTransform(dpi,0,0,dpi,0,0);
}
fixDPI(); addEventListener('resize', fixDPI);

const W = ()=> canvas.clientWidth;
const H = ()=> canvas.clientHeight;
const GROUND_Y = ()=> H()*0.80;

// الحالة
let running=false, gameOver=false, won=false;
let distance=0, score=0, best=+localStorage.getItem('fly-best')||0;
let speed=6, grace=0; // مهلة أمان
bestEl.textContent=best; distEl.textContent=distance;

// الصوت (نستخدم WebAudio لو متاح)
let AC, ctx, gain, musicGain, sfxGain, musicBuf=null, loseBuf=null, winBuf=null;
let musicNode=null;
const audioOn = {value:true};

async function loadBuffer(url){
  if(!ctx) return null;
  const res = await fetch(url); const arr=await res.arrayBuffer();
  return await ctx.decodeAudioData(arr);
}
async function audioInit(){
  if (ctx) return;
  AC = window.AudioContext || window.webkitAudioContext;
  if (!AC) return;
  ctx = new AC();
  gain = ctx.createGain(); gain.gain.value = .9; gain.connect(ctx.destination);
  musicGain = ctx.createGain(); musicGain.gain.value=.35; musicGain.connect(gain);
  sfxGain = ctx.createGain(); sfxGain.gain.value=.6; sfxGain.connect(gain);
  // لديك روابط الصوت بالفعل سابقاً؛ يمكن ربطها هنا لو رغبت
  // musicBuf = await loadBuffer("https://files.catbox.moe/c2gfi5.mp3");
  // loseBuf  = await loadBuffer("https://files.catbox.moe/81wdzo.mp3");
  // winBuf   = await loadBuffer("https://files.catbox.moe/8ob2jc.mp3");
}
function playBuf(buf, dst=musicGain, loop=false){
  if (!ctx || !buf || !audioOn.value) return null;
  const src = ctx.createBufferSource();
  src.buffer = buf; src.loop = loop; src.connect(dst); src.start();
  return src;
}
function beep(freq=800, dur=.08){
  if (!ctx || !audioOn.value) return;
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(sfxGain);
  g.gain.setValueAtTime(.0001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.6, ctx.currentTime+.01);
  g.gain.exponentialRampToValueAtTime(.0001, ctx.currentTime+dur);
  o.start(); o.stop(ctx.currentTime+dur+.01);
}

// زر كتم
btnMute.addEventListener('click', ()=>{
  audioOn.value = !audioOn.value;
  btnMute.textContent = audioOn.value ? 'إيقاف الصوت 🔊' : 'تشغيل الصوت 🔈';
  if (ctx && ctx.state==='suspended') ctx.resume();
});

// الموارد الرسومية
const riderImg = new Image(); riderImg.src = RIDER_IMG;

// اللاعب
const rider = { x: 86, y: 0, w: 86, h: 52, vy:0, onGround:true };

// عوائق بسيطة (مستطيلات)
const obstacles = [];
function spawnObstacle(force=false){
  const gap = 140 + Math.random()*110;
  const last = obstacles[obstacles.length-1];
  const baseX = last ? last.x + last.w + gap : W()+60;
  const h = 24 + Math.random()*40;
  const w = 26 + Math.random()*36;
  const y = GROUND_Y() - h;
  // تأخير أول عائق علشان المهلة
  obstacles.push({x: (force? baseX : baseX + (obstacles.length?0:220)), y, w, h});
}
function resetObstacles(){
  obstacles.length=0; for(let i=0;i<6;i++) spawnObstacle(true);
}

// خلفية ديناميكية
let clouds = [];
function resetClouds(){
  clouds = Array.from({length:6},(_,i)=>({
    x: Math.random()*W(), y: 40+Math.random()*120, r: 60+Math.random()*70, s: .25+.35*Math.random()
  }));
}
resetClouds();

function drawSky(){
  const p = Math.min(1, distance/10000); // نسبة التقدم
  // ألوان حسب المرحلة
  let top,bottom, starAlpha=0;
  if (p < .25){ top='#9ad6ff'; bottom='#e8f7ff'; }
  else if (p < .5){ top='#6bc2ff'; bottom='#d8f0ff'; }
  else if (p < .75){ top='#ffb07a'; bottom='#ffd3a6'; }
  else { top='#0b1b2b'; bottom='#0a1624'; starAlpha = (p-.75)/.25; }

  const g = c.createLinearGradient(0,0,0,H());
  g.addColorStop(0, top); g.addColorStop(1, bottom);
  c.fillStyle=g; c.fillRect(0,0,W(),H());

  // نجوم عند الليل
  if (starAlpha>0){
    c.globalAlpha=0.35*starAlpha;
    c.fillStyle='#ffffff';
    for(let i=0;i<70;i++){
      const x = (i*97 + (Date.now()/50)) % W();
      const y = (i*53)% (H()*0.6);
      c.fillRect(x,y,1,1);
    }
    c.globalAlpha=1;
  }

  // سحب
  c.fillStyle='rgba(255,255,255,.9)';
  clouds.forEach(cl=>{
    cl.x -= cl.s*(1.2+speed*0.04);
    if (cl.x < -cl.r*2) { cl.x = W()+cl.r; cl.y= 40+Math.random()*120; cl.r=60+Math.random()*70; }
    c.beginPath();
    c.arc(cl.x, cl.y, cl.r*.8, 0, Math.PI*2);
    c.arc(cl.x+cl.r*.7, cl.y+10, cl.r*.65, 0, Math.PI*2);
    c.arc(cl.x-cl.r*.6, cl.y+16, cl.r*.5, 0, Math.PI*2);
    c.fill();
  });

  // طريق + خطوط
  const gy = GROUND_Y();
  c.fillStyle='#cbd7e2';
  c.fillRect(0, gy, W(), 2);
  c.fillStyle='#ffffff';
  const seg=44,gap=80,off=-(Date.now()/20 % (seg+gap));
  for(let x=off; x<W(); x+=seg+gap) c.fillRect(x, gy-6, seg, 3);
}

// ظل الموتوسيكل وتوهج
function drawShadow(){
  const x = rider.x + rider.w*0.55;
  c.save();
  c.fillStyle='rgba(0,0,0,.18)';
  c.beginPath(); c.ellipse(x, GROUND_Y()+6, 44, 10, 0, 0, Math.PI*2); c.fill();
  c.restore();
}

function drawRider(){
  drawShadow();
  c.drawImage(riderImg, rider.x, rider.y, rider.w, rider.h);
}

// العوائق
function drawObstacles(){
  c.fillStyle='#243447';
  obstacles.forEach(o=>{ o.x -= speed; c.fillRect(o.x, o.y, o.w, o.h); });
  while(obstacles.length && obstacles[0].x+obstacles[0].w< -10){ obstacles.shift(); spawnObstacle(true); }
}

// فيزياء + تصادم
function physics(dt){
  rider.vy += 0.68; rider.y += rider.vy;
  if (rider.y + rider.h >= GROUND_Y()){ rider.y = GROUND_Y()-rider.h; rider.vy=0; rider.onGround=true; }

  if (grace>0){ grace -= dt; return; } // مهلة أمان

  // AABB
  const rx = rider.x+14, ry=rider.y+8, rw=rider.w-24, rh=rider.h-12;
  for(const o of obstacles){
    if (rx < o.x+o.w && rx+rw>o.x && ry < o.y+o.h && ry+rh>o.y){
      endGame(false);
      break;
    }
  }
}

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2500); }

// يافطة المدينة
let lastCityShown = 0;
function maybeShowCity(){
  const step = Math.floor(distance/1000);
  if (step>0 && step<=10 && step!==lastCityShown){
    lastCityShown = step;
    bannerCity.textContent = CITIES[step-1] || 'مدينة';
    banner.classList.remove('show'); // إعادة
    void banner.offsetWidth;         // reflow
    banner.classList.add('show');
    setTimeout(()=>banner.classList.remove('show'), 2200);
  }
}

/* ====== حلقة اللعبة ====== */
let last=0;
function loop(ts){
  if (!running) return;
  const dt = Math.min(1.6, (ts-last)/16.67); last=ts;

  c.clearRect(0,0,W(),H());
  drawSky();
  drawObstacles();
  physics(dt);
  drawRider();

  // تقدّم النقاط والسرعة
  distance += Math.max(1, Math.floor(dt));
  speed = 6 + Math.min(6, distance/1600);
  distEl.textContent = distance;

  maybeShowCity();

  if (distance>=10000){ endGame(true); return; }
  requestAnimationFrame(loop);
}

/* ====== التحكم ====== */
function startGame(){
  if (running) return;
  audioInit();
  running=true; gameOver=false; won=false;
  toast.classList.remove('show');
  distance=0; speed=6; lastCityShown=0; grace=1.2; // مهلة أمان
  rider.y = GROUND_Y()-rider.h; rider.vy=0; rider.onGround=true;
  resetObstacles(); resetClouds();
  last=performance.now(); requestAnimationFrame(loop);
}
function endGame(isWin){
  running=false; gameOver=true; won=isWin;
  best=Math.max(best,distance); localStorage.setItem('fly-best',best); bestEl.textContent=best;
  if (navigator.vibrate) navigator.vibrate(isWin? [40,50,40] : 120);
  if (isWin){
    showToast('🎉 مبروك! كسبت توصيلة مجانية — خُد لقطة شاشة وابعتها لنا على واتساب ✅');
  }else{
    showToast('💥 أوووبس! حاول تاني — اضغط الشاشة لإعادة المحاولة');
  }
}

function jump(){
  if (!running){ startGame(); return; }
  if (!rider.onGround || gameOver) return;
  rider.vy = -12.8; rider.onGround=false; beep(920,.07);
}

btnStart.addEventListener('click', ()=> running? null : startGame());
addEventListener('keydown', (e)=>{
  if ([' ','ArrowUp','w','W'].includes(e.key)){ e.preventDefault(); jump(); }
  if (['r','R'].includes(e.key) && gameOver){ startGame(); }
});
canvas.addEventListener('pointerdown', jump);
banner.addEventListener('pointerdown', (e)=>e.stopPropagation()); // لا تضغط من فوق الكانفس

// ابدأ أول وضعية ساكنة
rider.y = GROUND_Y()-rider.h;

</script>
</body>
</html>
