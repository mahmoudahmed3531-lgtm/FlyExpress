<script>
(function(){
  const AUDIO_URL = "https://h.uguu.se/kwmAtLDd.mp3";
  const audioEl = document.getElementById('bgAudio');
  const gate = document.getElementById('soundGate');
  const startBtn = document.getElementById('startSoundBtn');

  // Ø±Ø³Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©
  function tip(msg){
    startBtn.textContent = msg + " â€” Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸµ";
    setTimeout(()=>{ startBtn.textContent = "Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„ ğŸµ"; }, 2500);
  }

  async function playViaHTMLAudio(){
    try {
      audioEl.pause();
      audioEl.currentTime = 0;
      audioEl.muted = false;
      // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØ­ØªØ§Ø¬ load Ù‚Ø¨Ù„ play
      audioEl.load();
      await audioEl.play();
      return true;
    } catch (e) {
      return false;
    }
  }

  async function playViaWebAudio(){
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return false;
      const ctx = new AC();
      const resp = await fetch(AUDIO_URL, { mode: 'cors', cache: 'no-store' });
      const buf = await resp.arrayBuffer();
      const audioBuf = await ctx.decodeAudioData(buf);
      const src = ctx.createBufferSource();
      src.buffer = audioBuf;
      src.connect(ctx.destination);
      src.start(0);
      // Ù†Ø®Ù„ÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø© ØªØ®ØªÙÙŠ ÙˆÙ†Ø³ÙŠØ¨ Ø§Ù„ØµÙˆØª ÙŠÙƒÙ…Ù‘Ù„
      return true;
    } catch(e){
      return false;
    }
  }

  async function start(){
    startBtn.disabled = true;

    // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    let ok = await playViaHTMLAudio();
    if (ok){
      gate.style.display = 'none';
      startBtn.disabled = false;
      return;
    }

    // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: WebAudio (Fallback Ù‚ÙˆÙŠ)
    ok = await playViaWebAudio();
    if (ok){
      gate.style.display = 'none';
      startBtn.disabled = false;
      return;
    }

    // Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªÙ†ÙŠÙ† (Ù†Ø§Ø¯Ø±Ù‹Ø§): Ø§Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶ØºØ·
    tip("Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„");
    startBtn.disabled = false;
  }

  // Ø§Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø«
  startBtn.addEventListener('click', start, { passive: true });

  // Ù†Ø®Ù„ÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø¸Ø§Ù‡Ø±Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù„Ø­Ø¯ Ù…Ø§ ÙŠØ¶ØºØ·
  gate.style.display = 'grid';
})();
</script>
